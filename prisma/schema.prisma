// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  email               String   @unique
  password            String
  name                String?
  role                String   @default("user")
  isApproved          Boolean  @default(false)
  accessIngenieria    Boolean  @default(false)
  accessSubcontratos  Boolean  @default(false)
  accessContabilidad  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Budget {
  id          Int          @id @default(autoincrement())
  projectName String
  description String?
  date        DateTime     @default(now())
  totalAmount Decimal      @default(0) @db.Decimal(18, 6)
  items       BudgetItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Retention {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  percentage  Decimal  @db.Decimal(18, 6)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UnitOfMeasure {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BudgetItem {
  id          Int           @id @default(autoincrement())
  budgetId    Int
  budget      Budget        @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  code        String?       // Ej: 01.01.01
  description String
  unit        String?       // Ej: m2, UND, GLB
  quantity    Decimal       @default(0) @db.Decimal(18, 6)
  unitPrice   Decimal       @default(0) @db.Decimal(18, 6)
  total       Decimal       @default(0) @db.Decimal(18, 6)
  isChapter   Boolean       @default(false)
  measurements Measurement[]
}

model Measurement {
  id              Int        @id @default(autoincrement())
  budgetItemId    Int
  budgetItem      BudgetItem @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)
  externalTransID String     // AdmCloud TransID
  externalItemID  String     // AdmCloud ItemID
  quantity        Decimal    @db.Decimal(18, 6) // Cantidad medida/vinculada
  price           Decimal    @db.Decimal(18, 6) // Precio en la OC
  date            DateTime   @default(now())
  notes           String?
  createdAt       DateTime   @default(now())
}

model PaymentRequest {
  id                   Int                  @id @default(autoincrement())
  docNumber            String               @unique // Correlativo interno o num boletín
  externalTxID         String               // AdmCloud TransID (OC)
  docID                String               // AdmCloud DocID (Ej: OC-001)
  vendorName           String
  vendorFiscalID       String?              // RNC o Cédula del proveedor
  projectName          String?
  receptionNumbers     String?              // Ej: ICI-RIN00001, ICI-RIN00002
  measurementStartDate DateTime?            // Periodo de medición - desde
  measurementEndDate   DateTime?            // Periodo de medición - hasta
  date                 DateTime             @default(now())
  subTotal          Decimal              @db.Decimal(18, 6)
  taxAmount         Decimal              @db.Decimal(18, 6)
  retentionPercent  Decimal              @default(0) @db.Decimal(18, 6) // Ej: 5% Fondo Reparo
  retentionAmount   Decimal              @default(0) @db.Decimal(18, 6)
  advancePercent    Decimal              @default(0) @db.Decimal(18, 6) // Descuento de anticipo
  advanceAmount     Decimal              @default(0) @db.Decimal(18, 6)
  isrPercent        Decimal              @default(0) @db.Decimal(18, 6) // Retención ISR
  isrAmount         Decimal              @default(0) @db.Decimal(18, 6)
  netTotal          Decimal              @db.Decimal(18, 6) // subTotal + tax - retenciones
  status            String               @default("PENDIENTE") 
  rejectionReason   String?              // Motivo del rechazo (si aplica)
  lines             PaymentRequestLine[]
  paymentScheduleLines PaymentScheduleLine[]
  createdAt         DateTime             @default(now())
}

model PaymentSchedule {
  id               Int                   @id @default(autoincrement())
  scheduleNumber   String                @unique
  date             DateTime              @default(now())
  commitmentDate   DateTime
  paymentDate      DateTime
  status           String                @default("PENDIENTE_APROBACION") // PENDIENTE_APROBACION | APROBADA | ENVIADA_FINANZAS
  notes            String?
  approvedAt       DateTime?
  approvedBy       String?
  sentToFinanceAt  DateTime?
  sentToFinanceBy  String?
  lines            PaymentScheduleLine[]
  auditLogs        PaymentScheduleAudit[]
  createdAt        DateTime              @default(now())
}

model PaymentScheduleAudit {
  id               Int             @id @default(autoincrement())
  paymentScheduleId Int
  action           String
  statusBefore     String?
  statusAfter      String?
  detail           String?
  createdBy        String?
  createdAt        DateTime        @default(now())
  paymentSchedule  PaymentSchedule @relation(fields: [paymentScheduleId], references: [id], onDelete: Cascade)

  @@index([paymentScheduleId, createdAt])
}

model PaymentScheduleLine {
  id               Int             @id @default(autoincrement())
  paymentScheduleId Int
  paymentRequestId Int             @unique
  paymentSchedule  PaymentSchedule @relation(fields: [paymentScheduleId], references: [id], onDelete: Cascade)
  paymentRequest   PaymentRequest  @relation(fields: [paymentRequestId], references: [id], onDelete: Restrict)
  createdAt        DateTime        @default(now())

  @@unique([paymentScheduleId, paymentRequestId])
}

model PaymentRequestLine {
  id               Int            @id @default(autoincrement())
  paymentRequestId Int
  paymentRequest   PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  externalItemID   String
  description      String
  unitOfMeasure    String?
  receptionNumbers String?        // Ej: ICI-RIN00001
  quantity         Decimal        @db.Decimal(18, 6) // Cantidad a pagar en este boletín
  unitPrice        Decimal        @db.Decimal(18, 6)
  taxType          String         // Ej: ITBIS 18%, ITBIS 0%
  taxPercent       Decimal        @db.Decimal(18, 6)
  taxAmount        Decimal        @db.Decimal(18, 6) // Calculado x linea
  retentionPercent Decimal        @default(0) @db.Decimal(18, 6) // Retención por línea (ej: 5%)
  retentionAmount  Decimal        @default(0) @db.Decimal(18, 6) // Monto retenido por línea
  itbisRetentionPercent Decimal   @default(0) @db.Decimal(18, 6) // Retención de ITBIS (0%, 10%, 100%)
  totalLine        Decimal        @db.Decimal(18, 6) // quantity * unitPrice + taxAmount - retentionAmount
}

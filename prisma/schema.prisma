// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  email               String   @unique
  password            String
  name                String?
  role                String   @default("user")
  isApproved          Boolean  @default(false)
  accessIngenieria    Boolean  @default(false)
  accessSubcontratos  Boolean  @default(false)
  accessContabilidad  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Budget {
  id          Int          @id @default(autoincrement())
  projectName String
  description String?
  date        DateTime     @default(now())
  totalAmount Float        @default(0)
  items       BudgetItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Retention {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  percentage  Float
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BudgetItem {
  id          Int           @id @default(autoincrement())
  budgetId    Int
  budget      Budget        @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  code        String?       // Ej: 01.01.01
  description String
  unit        String?       // Ej: m2, UND, GLB
  quantity    Float         @default(0)
  unitPrice   Float         @default(0)
  total       Float         @default(0)
  isChapter   Boolean       @default(false)
  measurements Measurement[]
}

model Measurement {
  id              Int        @id @default(autoincrement())
  budgetItemId    Int
  budgetItem      BudgetItem @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)
  externalTransID String     // AdmCloud TransID
  externalItemID  String     // AdmCloud ItemID
  quantity        Float      // Cantidad medida/vinculada
  price           Float      // Precio en la OC
  date            DateTime   @default(now())
  notes           String?
  createdAt       DateTime   @default(now())
}

model PaymentRequest {
  id                Int                  @id @default(autoincrement())
  docNumber         String               @unique // Correlativo interno o num boletín
  externalTxID      String               // AdmCloud TransID (OC)
  docID             String               // AdmCloud DocID (Ej: OC-001)
  vendorName        String
  vendorFiscalID    String?              // RNC o Cédula del proveedor
  projectName       String?
  receptionNumbers  String?              // Ej: ICI-RIN00001, ICI-RIN00002
  date              DateTime             @default(now())
  subTotal          Float
  taxAmount         Float
  retentionPercent  Float                @default(0) // Ej: 5% Fondo Reparo
  retentionAmount   Float                @default(0)
  advancePercent    Float                @default(0) // Descuento de anticipo
  advanceAmount     Float                @default(0)
  isrPercent        Float                @default(0) // Retención ISR
  isrAmount         Float                @default(0)
  netTotal          Float                // subTotal + tax - retenciones
  status            String               @default("PENDIENTE") 
  rejectionReason   String?              // Motivo del rechazo (si aplica)
  lines             PaymentRequestLine[]
  createdAt         DateTime             @default(now())
}

model PaymentRequestLine {
  id               Int            @id @default(autoincrement())
  paymentRequestId Int
  paymentRequest   PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  externalItemID   String
  description      String
  receptionNumbers String?        // Ej: ICI-RIN00001
  quantity         Float          // Cantidad a pagar en este boletín
  unitPrice        Float
  taxType          String         // Ej: ITBIS 18%, ITBIS 0%
  taxPercent       Float
  taxAmount        Float          // Calculado x linea
  retentionPercent Float          @default(0) // Retención por línea (ej: 5%)
  retentionAmount  Float          @default(0) // Monto retenido por línea
  itbisRetentionPercent Float     @default(0) // Retención de ITBIS (0%, 10%, 100%)
  totalLine        Float          // quantity * unitPrice + taxAmount - retentionAmount
}
